#!/usr/bin/env bash

set -euo pipefail

# List staged files
files=$(git diff --name-only --staged)

for file in "${files[@]}"; do
  # Calculate SHA512 of file
  hash=$(openssl sha512 -binary "$file" | base64)

  # Query deps.dev
  json=$(
    curl --silent --get \
      --data-urlencode "hash.type=SHA512" \
      --data-urlencode "hash.value=$hash" \
      "https://api.deps.dev/v3alpha/query"
  )

  # If not found continue to next iteration
  if [ -z "$json" ]; then
    continue
  fi

  # Print package name and version
  echo Detected "$(jq -r '.versions[0] | .versionKey | (.name + " " + .version)' <<<"$json")"

  # Print vulnerabilities
  vulnerabilities=$(jq -r '.versions[0] | .advisoryKeys | length' <<<"$json")
  if [[ "$vulnerabilities" -gt 0 ]]; then
    echo Found $vulnerabilities vulnerabilities:
    jq -r '.versions[0] | .advisoryKeys | .[] | [.id] | @tsv' <<<$json

    # Exit with error
    (exit 1) && true
  fi
done
