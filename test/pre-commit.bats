#!/usr/bin/env bats

@test "should not report on no files" {
  echo "Hello world" >test.txt
  git add test.txt

  run .git/hooks/pre-commit

  [ "$status" -eq 0 ]
  [ "$output" = "" ]
}

@test "should report non-vulnerable lodash" {
  curl --silent --remote-name https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz
  git add lodash-4.17.21.tgz

  run .git/hooks/pre-commit

  [ "$status" -eq 0 ]
  [ "$output" = "Detected lodash 4.17.21" ]
}

@test "should report single vulnerable package" {
  curl --silent --remote-name https://registry.npmjs.org/lodash/-/lodash-4.17.20.tgz
  git add lodash-4.17.20.tgz

  run .git/hooks/pre-commit

  [ "$status" -eq 1 ]
  [ "$output" = "Detected lodash 4.17.20
Found 2 vulnerabilities:
GHSA-29mw-wpgm-hmr9
GHSA-35jh-r3h4-6jhm" ]
}

@test "should detect multiple non-vulnerable packages" {
  curl --silent --remote-name https://registry.npmjs.org/lodash/-/lodash-4.17.21.tgz
  curl --silent --remote-name https://registry.npmjs.org/express/-/express-4.18.2.tgz
  git add lodash-4.17.21.tgz
  git add express-4.18.2.tgz

  run .git/hooks/pre-commit

  [ "$status" -eq 0 ]
  [ "$output" = "Detected express 4.18.2
Detected lodash 4.17.21" ]
}

@test "should detect multiple packages one vulnerable" {
  curl --silent --remote-name https://registry.npmjs.org/lodash/-/lodash-4.17.20.tgz
  curl --silent --remote-name https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.17.1/log4j-core-2.17.1.jar
  git add lodash-4.17.20.tgz log4j-core-2.17.1.jar

  run .git/hooks/pre-commit

  [ "$status" -eq 1 ]
  [ "$output" = "Detected lodash 4.17.20
Found 2 vulnerabilities:
GHSA-29mw-wpgm-hmr9
GHSA-35jh-r3h4-6jhm
Detected org.apache.logging.log4j:log4j-core 2.17.1" ]
}

@test "should report multiple vulnerable packages" {
  curl --silent --remote-name https://registry.npmjs.org/lodash/-/lodash-4.17.20.tgz
  curl --silent --remote-name https://repo1.maven.org/maven2/org/apache/logging/log4j/log4j-core/2.17.0/log4j-core-2.17.0.jar
  git add lodash-4.17.20.tgz log4j-core-2.17.0.jar

  run .git/hooks/pre-commit

  [ "$status" -eq 1 ]
  [ "$output" = "Detected lodash 4.17.20
Found 2 vulnerabilities:
GHSA-29mw-wpgm-hmr9
GHSA-35jh-r3h4-6jhm
Detected org.apache.logging.log4j:log4j-core 2.17.0
Found 1 vulnerabilities:
GHSA-8489-44mv-ggj8" ]
}

setup() {
  rm -rf $BATS_TMPDIR/$BATS_TEST_NAME
  mkdir -p $BATS_TMPDIR/$BATS_TEST_NAME
  cd $BATS_TMPDIR/$BATS_TEST_NAME

  git init
  cp $BATS_TEST_DIRNAME/../src/pre-commit .git/hooks/pre-commit
}
